# ğŸ¬ Diagrama Visual: Flow Execution Pipeline

---

## ğŸ“Š Diagrama 1: Fluxo Completo de Uma Mensagem

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸŒ USUÃRIO WhatsApp                              â”‚
â”‚                Envia mensagem "Oi" via WhatsApp                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTP POST
                      â”‚ X-Hub-Signature-256: sha256=abc123...
                      â”‚ Content:
                      â”‚ {
                      â”‚   "entry": [{
                      â”‚     "changes": [{
                      â”‚       "value": {
                      â”‚         "messages": [{
                      â”‚           "from": "5511999999999",
                      â”‚           "type": "text",
                      â”‚           "text": {"body": "Oi"}
                      â”‚         }]
                      â”‚       }
                      â”‚     }]
                      â”‚   }]
                      â”‚ }
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ” backend/app/api/v1/router.py:81                              â”‚
â”‚               POST /api/v1/whatsapp/webhook                             â”‚
â”‚                                                                          â”‚
â”‚  1ï¸âƒ£ receive_webhook()                                                  â”‚
â”‚     â”œâ”€ Extrai raw_body                                                 â”‚
â”‚     â”œâ”€ Valida X-Hub-Signature-256                                      â”‚
â”‚     â”œâ”€ Busca WhatsAppNumber pelo phone_number_id                      â”‚
â”‚     â”œâ”€ Verifica app_secret vs signature (HMAC)                        â”‚
â”‚     â””â”€ Chama WhatsAppService.process_webhook()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ¯ backend/app/services/whatsapp_service.py:4099                â”‚
â”‚           WhatsAppService.process_webhook(payload)                     â”‚
â”‚                                                                          â”‚
â”‚  2ï¸âƒ£ process_webhook()                                                  â”‚
â”‚     â”œâ”€ Para cada entry â†’ para cada change:                            â”‚
â”‚     â”‚  â”œâ”€ Extrai phone_number_id                                      â”‚
â”‚     â”‚  â”œâ”€ Busca WhatsAppNumber do DB                                  â”‚
â”‚     â”‚  â”œâ”€ Extrai:                                                      â”‚
â”‚     â”‚  â”‚  â”œâ”€ org_id â† identifica organizaÃ§Ã£o                          â”‚
â”‚     â”‚  â”‚  â”œâ”€ phone_number_obj_id â† identifica WhatsAppNumber         â”‚
â”‚     â”‚  â”‚  â”œâ”€ default_chatbot_id â† pode ser NULL                       â”‚
â”‚     â”‚  â”‚  â””â”€ default_flow_id â† pode ser NULL                          â”‚
â”‚     â”‚  â”‚                                                               â”‚
â”‚     â”‚  â””â”€ Para cada mensagem:                                         â”‚
â”‚     â”‚     â””â”€ Chama _process_incoming_message()                        â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â””â”€ await db.commit()                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ¬ backend/app/services/whatsapp_service.py:4190                â”‚
â”‚         _process_incoming_message(message, org_id, ...)                â”‚
â”‚                                                                          â”‚
â”‚  3ï¸âƒ£ _process_incoming_message()                                        â”‚
â”‚     â”œâ”€ ContactRepository.get_by_whatsapp_id()                          â”‚
â”‚     â”‚  â””â”€ Se nÃ£o existe: cria novo Contact                            â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ ConversationRepository.get_by_contact(status='open')            â”‚
â”‚     â”‚  â””â”€ Se nÃ£o existe: CRIA NOVA CONVERSATION COM:                  â”‚
â”‚     â”‚     â”œâ”€ is_bot_active = True if default_chatbot_id or            â”‚
â”‚     â”‚     â”‚                         default_flow_id else False         â”‚
â”‚     â”‚     â”œâ”€ active_chatbot_id = default_chatbot_id                    â”‚
â”‚     â”‚     â”œâ”€ active_flow_id = default_flow_id                          â”‚
â”‚     â”‚     â””â”€ current_node_id = start_node.id (se flow)                 â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ MessageRepository.create(message_data)                          â”‚
â”‚     â”‚  â””â”€ Salva mensagem de entrada no DB                             â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ Emit WebSocket: event="message:new"                            â”‚
â”‚     â”‚  â””â”€ Notifica agentes em tempo real                              â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â””â”€ âœ… NOVO: Verifica AMBAS as condiÃ§Ãµes:                          â”‚
â”‚        â”‚  if conversation.is_bot_active AND                           â”‚
â”‚        â”‚     (conversation.active_chatbot_id OR                       â”‚
â”‚        â”‚      conversation.active_flow_id):  â† MUDANÃ‡A CRÃTICA         â”‚
â”‚        â”‚        Chama _trigger_chatbot()                              â”‚
â”‚        â”‚                                                               â”‚
â”‚        â””â”€ await db.commit()                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚
   Primeira Mensagem      PrÃ³ximas Mensagens
   (Inicializa)           (Continua)
          â”‚                       â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flow nÃ£o existe  â”‚      â”‚ Flow jÃ¡ existe   â”‚
â”‚ (active_flow_id) â”‚      â”‚ (active_flow_id) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Buscar main_flow â”‚      â”‚ Buscar current   â”‚
â”‚ do chatbot       â”‚      â”‚ node_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Buscar start_nodeâ”‚      â”‚ Processar        â”‚
â”‚ do main_flow     â”‚      â”‚ resposta usuÃ¡rio â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ğŸ¤– backend/app/services/whatsapp_service.py:140                 â”‚
â”‚              _execute_node(conversation, node, flow, msg)               â”‚
â”‚                                                                          â”‚
â”‚  4ï¸âƒ£ _execute_node()                                                    â”‚
â”‚     â”œâ”€ Valida node type vs connection_type (Meta Cloud API)            â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ Processa node especÃ­fico:                                       â”‚
â”‚     â”‚  â”œâ”€ condition â†’ avalia condiÃ§Ãµes â†’ avanÃ§a por path               â”‚
â”‚     â”‚  â”œâ”€ handoff â†’ transfere para agente humano                       â”‚
â”‚     â”‚  â”œâ”€ action â†’ executa webhook/save/update var                     â”‚
â”‚     â”‚  â”œâ”€ api_call â†’ faz HTTP call externa                             â”‚
â”‚     â”‚  â”œâ”€ ai_prompt â†’ chama IA (Claude, GPT)                           â”‚
â”‚     â”‚  â”œâ”€ question â†’ envia pergunta com opÃ§Ãµes                         â”‚
â”‚     â”‚  â”œâ”€ message â†’ envia mensagem de texto                            â”‚
â”‚     â”‚  â”œâ”€ interactive_buttons â†’ botÃµes clicÃ¡veis                       â”‚
â”‚     â”‚  â”œâ”€ interactive_list â†’ menu com opcoes                           â”‚
â”‚     â”‚  â”œâ”€ whatsapp_template â†’ template oficial                         â”‚
â”‚     â”‚  â””â”€ end â†’ mensagem de finalizaÃ§Ã£o                                â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ Substitui variÃ¡veis {{variable}} do context_variables           â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â”œâ”€ Envia via Meta Cloud API:                                       â”‚
â”‚     â”‚  â””â”€ MetaCloudAPI.send_text_message()                             â”‚
â”‚     â”‚     â””â”€ response: {"messages": [{"id": "wamid.yyy"}]}             â”‚
â”‚     â”‚                                                                   â”‚
â”‚     â””â”€ Chama _advance_to_next_node()                                   â”‚
â”‚        â””â”€ Atualiza conversation.current_node_id para prÃ³ximo node      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ response
                      â”‚ wamid.yyy
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â˜ï¸  Meta Cloud API                                   â”‚
â”‚                   Instagram Graph API                                    â”‚
â”‚               POST /v18.0/{phone_number_id}/messages                    â”‚
â”‚                                                                          â”‚
â”‚  Authorization: Bearer {access_token}                                   â”‚
â”‚  Content-Type: application/json                                         â”‚
â”‚  {                                                                       â”‚
â”‚    "messaging_product": "whatsapp",                                     â”‚
â”‚    "to": "5511999999999",                                              â”‚
â”‚    "type": "text",                                                      â”‚
â”‚    "text": {"body": "OlÃ¡! Como posso ajudar?"}                         â”‚
â”‚  }                                                                       â”‚
â”‚                                                                          â”‚
â”‚  Response 200 OK                                                         â”‚
â”‚  {                                                                       â”‚
â”‚    "messages": [{"id": "wamid.yyy"}]                                   â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Envia mensagem
                      â”‚ via WhatsApp Cloud
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“± USUÃRIO WhatsApp                                  â”‚
â”‚                   Recebe mensagem automÃ¡tica                            â”‚
â”‚                                                                          â”‚
â”‚             OlÃ¡! Como posso ajudar?                                    â”‚
â”‚                                                                          â”‚
â”‚             [OpÃ§Ã£o 1]  [OpÃ§Ã£o 2]  [OpÃ§Ã£o 3]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Diagrama 2: Ãrvore de DecisÃ£o em `_trigger_chatbot()`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _trigger_chatbot(conversation, new_message)                      â”‚
â”‚  Chamado de: _process_incoming_message()                          â”‚
â”‚  Contexto: Mensagem acaba de ser recebida e armazenada            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… NOVO: Verifica se hÃ¡ chatbot OU flow                            â”‚
â”‚                                                                    â”‚
â”‚  if NOT active_chatbot_id AND NOT active_flow_id:                 â”‚
â”‚      logger.warning("Nenhum chatbot ou flow ativo")               â”‚
â”‚      return  â† Sai sem fazer nada                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ (Algum deles existe)
                 â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                     â”‚
   Tem flow_id         Sem flow_id
   (jÃ¡ setado)         (precisa inicializar)
      â”‚                     â”‚
      â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ else:           â”‚   â”‚ if not flow_id:      â”‚
â”‚ (PrÃ³ximas msgs) â”‚   â”‚ (Primeira msg)       â”‚
â”‚                 â”‚   â”‚                      â”‚
â”‚ - Buscar        â”‚   â”‚ - Verificar          â”‚
â”‚   current_node  â”‚   â”‚   chatbot_id         â”‚
â”‚ - Buscar flow   â”‚   â”‚   (pode ser NULL)    â”‚
â”‚ - Processar     â”‚   â”‚                      â”‚
â”‚   resposta      â”‚   â”‚ âœ… NOVO:             â”‚
â”‚ - AvanÃ§ar para  â”‚   â”‚ if not chatbot_id:   â”‚
â”‚   prÃ³ximo node  â”‚   â”‚   logger.warning()   â”‚
â”‚                 â”‚   â”‚   return             â”‚
â”‚                 â”‚   â”‚                      â”‚
â”‚                 â”‚   â”‚ - Buscar main_flow   â”‚
â”‚                 â”‚   â”‚   do chatbot_id      â”‚
â”‚                 â”‚   â”‚ - Buscar start_node  â”‚
â”‚                 â”‚   â”‚ - Encontrar first    â”‚
â”‚                 â”‚   â”‚   node (via edges)   â”‚
â”‚                 â”‚   â”‚ - Atualizar          â”‚
â”‚                 â”‚   â”‚   conversation       â”‚
â”‚                 â”‚   â”‚ - Executar primeiro  â”‚
â”‚                 â”‚   â”‚   node               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ _execute_node()â”‚
        â”‚ (envia respostaâ”‚
        â”‚  automÃ¡tica)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Diagrama 3: Estados da Conversation

```
PRIMEIRA MENSAGEM RECEBIDA
â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Conversation criada:                                         â”‚
â”‚                                                              â”‚
â”‚ CenÃ¡rio A: Tem default_flow_id                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚ is_bot_active = TRUE       â† default_flow_id existe         â”‚
â”‚ active_chatbot_id = NULL   â† nÃ£o setado                     â”‚
â”‚ active_flow_id = UUID      â† setado do WhatsAppNumber       â”‚
â”‚ current_node_id = UUID     â† setado (start node id)         â”‚
â”‚                                                              â”‚
â”‚ âœ… _trigger_chatbot() â†’ ENTRA (porque active_flow_id)       â”‚
â”‚ âœ… Vai para branch: else (flow jÃ¡ existe)                   â”‚
â”‚ âœ… Executa node imediatamente                               â”‚
â”‚                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                              â”‚
â”‚ CenÃ¡rio B: Tem default_chatbot_id (LEGACY)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚ is_bot_active = TRUE       â† default_chatbot_id existe      â”‚
â”‚ active_chatbot_id = UUID   â† setado do WhatsAppNumber      â”‚
â”‚ active_flow_id = NULL      â† nÃ£o setado                     â”‚
â”‚ current_node_id = NULL     â† nÃ£o setado                     â”‚
â”‚                                                              â”‚
â”‚ âœ… _trigger_chatbot() â†’ ENTRA (porque active_chatbot_id)    â”‚
â”‚ âœ… Vai para branch: if (flow vazio)                         â”‚
â”‚ âœ… Busca main_flow do chatbot_id                            â”‚
â”‚ âœ… Atualiza active_flow_id                                  â”‚
â”‚ âœ… Executa primeiro node                                    â”‚
â”‚                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                              â”‚
â”‚ CenÃ¡rio C: Ambos setados (PRIORIDADE AO FLOW)             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ is_bot_active = TRUE       â† ambos existem                  â”‚
â”‚ active_chatbot_id = UUID   â† setado                         â”‚
â”‚ active_flow_id = UUID      â† setado (PRIORIDADE!)          â”‚
â”‚ current_node_id = UUID     â† setado (start node)            â”‚
â”‚                                                              â”‚
â”‚ âœ… _trigger_chatbot() â†’ ENTRA                               â”‚
â”‚ âœ… Vai para branch: else (flow jÃ¡ existe!)                  â”‚
â”‚ âœ… Executa flow_id (ignora chatbot_id)                      â”‚
â”‚                                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                              â”‚
â”‚ CenÃ¡rio D: Nenhum setado (SEM AUTOMAÃ‡ÃƒO)                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ is_bot_active = FALSE      â† nenhum setado                  â”‚
â”‚ active_chatbot_id = NULL   â† nÃ£o setado                     â”‚
â”‚ active_flow_id = NULL      â† nÃ£o setado                     â”‚
â”‚ current_node_id = NULL     â† nÃ£o setado                     â”‚
â”‚                                                              â”‚
â”‚ âŒ _trigger_chatbot() â†’ NÃƒO ENTRA (ambas condiÃ§Ãµes NULL)    â”‚
â”‚ âŒ Mensagem apenas armazenada                               â”‚
â”‚ âŒ Pode ser processada por agente humano depois              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Diagrama 4: ComparaÃ§Ã£o ANTES vs DEPOIS

```
ANTES (âŒ BUG) - SÃ³ aceitava chatbot_id
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if conversation.is_bot_active AND conversation.active_chatbot_id:
â”‚     await self._trigger_chatbot()
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CenÃ¡rio com default_flow_id apenas:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ is_bot_active = TRUE  (porque default_flow_id existe)       â”‚
â”‚ active_chatbot_id = NULL  (nÃ£o foi setado)                  â”‚
â”‚                                                              â”‚
â”‚ CondiÃ§Ã£o: TRUE AND NULL = FALSE                             â”‚
â”‚ âŒ NÃƒO ENTRA em _trigger_chatbot()                          â”‚
â”‚ âŒ Flow fica parado, sem executar                           â”‚
â”‚ âŒ UsuÃ¡rio nÃ£o recebe resposta                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


DEPOIS (âœ… CORRIGIDO) - Aceita ambas as opÃ§Ãµes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if conversation.is_bot_active AND                           â”‚
â”‚    (conversation.active_chatbot_id OR                       â”‚
â”‚     conversation.active_flow_id):                           â”‚
â”‚     await self._trigger_chatbot()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CenÃ¡rio com default_flow_id apenas:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ is_bot_active = TRUE  (porque default_flow_id existe)       â”‚
â”‚ active_chatbot_id = NULL  (nÃ£o foi setado)                  â”‚
â”‚ active_flow_id = UUID  (foi setado!)                        â”‚
â”‚                                                              â”‚
â”‚ CondiÃ§Ã£o: TRUE AND (NULL OR UUID) = TRUE                    â”‚
â”‚ âœ… ENTRA em _trigger_chatbot()                              â”‚
â”‚ âœ… Flow executa normalmente                                  â”‚
â”‚ âœ… UsuÃ¡rio recebe resposta                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CenÃ¡rio com ambos:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ is_bot_active = TRUE                                        â”‚
â”‚ active_chatbot_id = UUID  (setado)                          â”‚
â”‚ active_flow_id = UUID     (setado)                          â”‚
â”‚                                                              â”‚
â”‚ CondiÃ§Ã£o: TRUE AND (UUID OR UUID) = TRUE                    â”‚
â”‚ âœ… ENTRA em _trigger_chatbot()                              â”‚
â”‚ âœ… Executa active_flow_id (prioridade!)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Diagrama 5: Ciclo de Vida de Uma Conversation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONVERSA INICIA: Primeira mensagem recebida                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Estado 1: INITIALIZATION                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  Conversation.status = "open"                                   â”‚
â”‚  Conversation.is_bot_active = True (se tem chatbot/flow)        â”‚
â”‚  Conversation.messages_from_contact = 1                         â”‚
â”‚  Conversation.total_messages = 1                                â”‚
â”‚  Conversation.active_flow_id = {flow_id}                        â”‚
â”‚  Conversation.current_node_id = {start_node_id}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _trigger_chatbot() executado                                  â”‚
â”‚  Executa primeiro node do flow                                  â”‚
â”‚  Envia mensagem automÃ¡tica                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Estado 2: ACTIVE FLOW (Primeira â†’ Terceira Mensagem)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  Conversation.messages_from_contact = 2, 3, ...                â”‚
â”‚  Conversation.total_messages = 2, 3, ... (cont +outbound)      â”‚
â”‚  Conversation.current_node_id = {next_node_id}  (vai mudando)  â”‚
â”‚  Conversation.active_flow_id = {flow_id}  (mesmo)               â”‚
â”‚  Conversation.context_variables = {accumulated_data}  (cresce)  â”‚
â”‚                                                                  â”‚
â”‚  Cada mensagem do usuÃ¡rio:                                      â”‚
â”‚  â”œâ”€ Processa resposta                                          â”‚
â”‚  â”œâ”€ Avalia condiÃ§Ãµes (se applicable)                           â”‚
â”‚  â”œâ”€ AvanÃ§a para prÃ³ximo node                                   â”‚
â”‚  â”œâ”€ Executa novo node                                          â”‚
â”‚  â””â”€ Envia resposta                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Estado 3: END NODE REACHED                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚  Conversation.current_node_id = {end_node_id}                   â”‚
â”‚  Executa node "end" com farewell message                        â”‚
â”‚  Envia mensagem de despedida                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Estado 4: COMPLETED ou WAITING FOR HUMAN                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚  Conversation.status = "closed" (se completed)                  â”‚
â”‚  Conversation.is_bot_active = False (se transferido)            â”‚
â”‚  Conversation.current_agent_id = {agent_id}  (se human)         â”‚
â”‚                                                                  â”‚
â”‚  Se nÃ£o completed, pode ser:                                    â”‚
â”‚  â”œâ”€ Transferido para agente humano (handoff node)              â”‚
â”‚  â”œâ”€ Esperando resposta do contato                              â”‚
â”‚  â””â”€ Em fila de atendimento                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Diagrama 6: Mapa Mental das MudanÃ§as

```
                    FIX: Flow Execution
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
           MudanÃ§a 1              MudanÃ§a 2
        Linha 4396               Linha 48-66
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        CondiÃ§Ã£o de              ValidaÃ§Ã£o em
        disparo                  _trigger_chatbot
           â”‚                           â”‚
           â”œâ”€ Antes:                   â”œâ”€ Antes:
           â”‚  active_chatbot_id        â”‚  if not active_chatbot_id:
           â”‚                           â”‚      return
           â”œâ”€ Depois:                  â”‚
           â”‚  active_chatbot_id OR     â”œâ”€ Depois:
           â”‚  active_flow_id           â”‚  if not active_chatbot_id AND
           â”‚                           â”‚     not active_flow_id:
           â”‚  Impact:                  â”‚      return
           â”‚  âœ… Flow agora            â”‚
           â”‚     funciona              â”‚  Impact:
           â”‚     sem chatbot           â”‚  âœ… Aceita flows
           â”‚                           â”‚     jÃ¡ inicializados
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            âœ… Suporta 4 cenÃ¡rios
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚       â”‚       â”‚        â”‚
    Flow_id   Chatbot  Ambos   Nenhum
    apenas     apenas  setados  setado
         â”‚       â”‚       â”‚        â”‚
         âœ…      âœ…      âœ…       âœ…
      (Novo)   (Legacy) (OK)    (OK)
```

---

**DocumentaÃ§Ã£o Visual Completa** âœ…

PrÃ³ximo passo: Deploy e Testes! ğŸš€
