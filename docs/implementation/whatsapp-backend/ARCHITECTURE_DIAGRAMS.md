# ๐๏ธ ARQUITETURA VISUAL: Fluxo Completo

**Autor:** Kayo Carvalho Fernandes  
**Data:** 12 de dezembro de 2025  

---

## DIAGRAMA 1: Fluxo de Mensagem Incoming (Real-time)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ USUรRIO envia mensagem no WhatsApp                          โ
โ "Olรก, preciso de ajuda"                                     โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ META CLOUD API (Recebe + Valida)                            โ
โ โ Verifica que รฉ mensagem de texto vรกlida                  โ
โ โ Formata payload                                           โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ POST /api/v1/whatsapp/webhook
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ WEBHOOK RECEIVER (Backend - FastAPI)                        โ
โ โ Valida assinatura X-Hub-Signature-256                    โ
โ โ Valida estrutura de payload                               โ
โ โ RETORNA 200 OK IMEDIATAMENTE                              โ
โ โ Enfileira background job com: phone + message_text        โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ (ASYNC - Nรฃo bloqueia mais)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ BACKGROUND JOB QUEUE (Celery/APScheduler)                   โ
โ Processa: process_message_async(phone, text, webhook_data)  โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STEP 1: MESSAGE ROUTER                                      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Input: phone = "5511999999999"                       โ    โ
โ โ Query: SELECT * FROM whatsapp_numbers                โ    โ
โ โ        WHERE phone_number = ? AND org_id = ?         โ    โ
โ โ Output: WhatsAppNumber object with default_chatbot   โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                     โ                                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Load Chatbot (from default_chatbot_id or fallback)   โ    โ
โ โ Load Flow (from chatbot.flow_id)                     โ    โ
โ โ Output: (Chatbot, Flow) objects                      โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STEP 2: CONVERSATION STATE MANAGER                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Query: SELECT * FROM conversation_states             โ    โ
โ โ        WHERE org_id = ? AND phone = ? AND flow = ?   โ    โ
โ โ If exists: Load state                                โ    โ
โ โ If not: Create new:                                  โ    โ
โ โ   - current_node_id = null                           โ    โ
โ โ   - variables = {}                                   โ    โ
โ โ   - execution_path = []                              โ    โ
โ โ   - is_active = true                                 โ    โ
โ โ   - session_expires_at = now + 24h                   โ    โ
โ โ Output: ConversationState object                     โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STEP 3: FLOW EXECUTOR ENGINE                                โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Input:                                               โ    โ
โ โ   - flow: Flow object (nodes + edges)                โ    โ
โ โ   - state: ConversationState                         โ    โ
โ โ   - user_message: "Olรก, preciso de ajuda"            โ    โ
โ โ                                                      โ    โ
โ โ Process:                                             โ    โ
โ โ   1. If first message: current_node = "start"        โ    โ
โ โ   2. Loop through nodes (max 100 iterations)         โ    โ
โ โ   3. For each node:                                  โ    โ
โ โ      - Execute handler (START, MESSAGE, QUESTION...) โ    โ
โ โ      - Add responses to list                         โ    โ
โ โ      - Substitute {{variables}}                      โ    โ
โ โ      - Move to next node                             โ    โ
โ โ   4. Stop at QUESTION (awaiting input) or END        โ    โ
โ โ                                                      โ    โ
โ โ Output:                                              โ    โ
โ โ   - responses: ["Olรก!", "Como posso ajudar?"]       โ    โ
โ โ   - current_node_id: "node_question_topic"           โ    โ
โ โ   - variables: {"topic": null}                       โ    โ
โ โ   - execution_path: ["start", "greeting", ...]      โ    โ
โ โ   - awaiting_input: true                             โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STEP 4: MESSAGE SENDER (Meta API)                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ For each response in responses:                       โ    โ
โ โ   POST https://graph.instagram.com/v18.0/.../messagesโ    โ
โ โ   Body: {                                             โ    โ
โ โ     "to": "5511999999999",                            โ    โ
โ โ     "type": "text",                                   โ    โ
โ โ     "text": { "body": response }                      โ    โ
โ โ   }                                                   โ    โ
โ โ   Headers:                                            โ    โ
โ โ     Authorization: Bearer {META_ACCESS_TOKEN}         โ    โ
โ โ                                                      โ    โ
โ โ Retry logic:                                          โ    โ
โ โ   - If fails: retry em 60s, 120s, 240s               โ    โ
โ โ   - Max 3 tentativas                                 โ    โ
โ โ                                                      โ    โ
โ โ Output:                                               โ    โ
โ โ   - message_id: "wamid.XYZ="                          โ    โ
โ โ   - status: "sent"                                    โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ STEP 5: STATE SAVER + LOGGER                                โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Save new state to conversation_states:               โ    โ
โ โ UPDATE conversation_states                           โ    โ
โ โ SET current_node_id = "node_question_topic",         โ    โ
โ โ     variables = {...},                               โ    โ
โ โ     execution_path = [...],                          โ    โ
โ โ     updated_at = now                                 โ    โ
โ โ WHERE id = state.id                                  โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                     โ                                        โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ โ Log to conversation_logs (audit trail):              โ    โ
โ โ INSERT INTO conversation_logs:                       โ    โ
โ โ   - user_message: "Olรก, preciso de ajuda"            โ    โ
โ โ   - bot_response: "Olรก! Como posso ajudar?"          โ    โ
โ โ   - node_id: "node_question_topic"                   โ    โ
โ โ   - timestamp: now                                   โ    โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ META CLOUD API (Entrega ao Usuรกrio)                         โ
โ โ Recebe resposta "Olรก! Como posso ajudar?"                โ
โ โ Entrega ao nรบmero do usuรกrio                             โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ USUรRIO recebe mensagem no WhatsApp                         โ
โ "Olรก! Como posso ajudar?"                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โฑ๏ธ TEMPO TOTAL: ~1-3 segundos (webhook retorna em <100ms)
```

---

## DIAGRAMA 2: Prรณxima Mensagem (Conversa Continuada)

```
USUรRIO responde no mesmo chat:
"Preciso de informaรงรตes sobre Produto A"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Mesmo fluxo acima, MAS:                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ Estado Jร EXISTE                           โ
โ   - current_node_id = "node_question_topic"  โ
โ   - variables = {}                           โ
โ   - execution_path = ["start", "greeting"]   โ
โ                                              โ
โ โ Router encontra mesma conversa             โ
โ                                              โ
โ โ State Manager CARREGA estado existente     โ
โ   (nรฃo cria novo)                            โ
โ                                              โ
โ โ Flow Executor:                             โ
โ   - Comeรงa em "node_question_topic"          โ
โ   - Processa: input = "Produto A"            โ
โ   - Armazena: variables["topic"] = "A"       โ
โ   - Move para prรณximo node                   โ
โ   - Gera nova resposta                       โ
โ                                              โ
โ โ Resultado: Conversa contรญnua               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## DIAGRAMA 3: Frontend - Visรฃo de Conversas (Dashboard)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ FRONTEND: Conversas Page                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ [GET /api/v1/conversations]                                โ
โ โ                                                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ Lista de Conversas (COM PAGINAรรO)                   โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ โ โ Conversa 1                                         โ   โ
โ โ   Phone: +55 11 99999-9999                           โ   โ
โ โ   Flow: Atendimento Vendas                           โ   โ
โ โ   Status: ๐ข Ativo                                  โ   โ
โ โ   Current Node: node_question_product                โ   โ
โ โ   Messages: 5                                        โ   โ
โ โ   Last: 10:30 (2025-12-12)                           โ   โ
โ โ   โ Clique para ver histรณrico                        โ   โ
โ โ                                                      โ   โ
โ โ โ Conversa 2                                         โ   โ
โ โ   Phone: +55 11 88888-8888                           โ   โ
โ โ   Flow: Suporte Tรฉcnico                              โ   โ
โ โ   Status: ๐ด Finalizada                             โ   โ
โ โ   Messages: 12                                       โ   โ
โ โ   โ Clique para ver histรณrico                        โ   โ
โ โ                                                      โ   โ
โ โ ... (50 por pรกgina)                                  โ   โ
โ โ Pagination: < Anterior | Prรณxima >                  โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โ USER CLICKS: Conversa 1                                     โ
โ โ                                                           โ
โ [GET /api/v1/conversations/5511999999999]                 โ
โ โ                                                           โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ โ Histรณrico de Conversa Detalhado                       โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ โ                                                      โ   โ
โ โ Phone: +55 11 99999-9999                             โ   โ
โ โ Flow: Atendimento Vendas                             โ   โ
โ โ Current Node: node_question_product                  โ   โ
โ โ Status: ๐ข Ativo                                    โ   โ
โ โ                                                      โ   โ
โ โ โโโ CHAT HISTORY โโโ                                โ   โ
โ โ                                                      โ   โ
โ โ 09:00:05                                             โ   โ
โ โ ๐ค Bot: "Qual รฉ seu nome?"                          โ   โ
โ โ                                                      โ   โ
โ โ 09:00:10                                             โ   โ
โ โ ๐ค User: "Joรฃo Silva"                               โ   โ
โ โ                                                      โ   โ
โ โ 09:00:11                                             โ   โ
โ โ ๐ค Bot: "Temos 3 produtos!"                         โ   โ
โ โ         "1๏ธโฃ Produto A - R$ 100"                     โ   โ
โ โ         "2๏ธโฃ Produto B - R$ 150"                     โ   โ
โ โ         "3๏ธโฃ Produto C - R$ 200"                     โ   โ
โ โ                                                      โ   โ
โ โ 09:00:15                                             โ   โ
โ โ ๐ค User: "2"                                        โ   โ
โ โ         (awaiting bot response...)                   โ   โ
โ โ                                                      โ   โ
โ โ โโโ CURRENT STATE โโโ                               โ   โ
โ โ                                                      โ   โ
โ โ Current Node: node_question_product                  โ   โ
โ โ Variables:                                           โ   โ
โ โ   - nome: "Joรฃo Silva"                               โ   โ
โ โ   - produto: "2"                                     โ   โ
โ โ Execution Path: start โ greeting โ q_name โ          โ   โ
โ โ                 msg_products โ q_product             โ   โ
โ โ                                                      โ   โ
โ โ โโโ ACTIONS โโโ                                      โ   โ
โ โ                                                      โ   โ
โ โ [Test Message]  [Close Conversation] [Export PDF]    โ   โ
โ โ                                                      โ   โ
โ โ Input: [ Teste uma mensagem ______ ] [Send]         โ   โ
โ โ                                                      โ   โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                             โ
โ USER CLICKS: Test Message                                   โ
โ โ                                                           โ
โ [POST /api/v1/conversations/5511999999999/send]            โ
โ Body: { message: "Teste uma mensagem", flow_id: "..." }    โ
โ โ                                                           โ
โ Response:                                                   โ
โ {                                                           โ
โ   "status": "processed",                                    โ
โ   "user_message": "Teste uma mensagem",                     โ
โ   "bot_responses": ["Obrigado! Pedido processado"],         โ
โ   "current_node_id": "node_end",                            โ
โ   "awaiting_input": false                                   โ
โ }                                                           โ
โ โ                                                           โ
โ UI UPDATES:                                                โ
โ - Adiciona mensagem do usuรกrio ao chat                      โ
โ - Adiciona resposta do bot                                  โ
โ - Mark current node como "end"                              โ
โ - Show "Conversation ended"                                 โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## DIAGRAMA 4: Database Schema (Multi-tenancy)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ DATABASE TABLES (PostgreSQL)                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ organizations (existing)                                 โ
โ โโ id: UUID (PK)                                         โ
โ โโ name: VARCHAR                                         โ
โ โโ ...                                                   โ
โ    โ REFERENCED BY ALL TABLES                            โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ whatsapp_numbers (modified)                              โ
โ โโ id: UUID (PK)                                         โ
โ โโ organization_id: UUID (FK โ organizations)  ๐        โ
โ โโ phone_number: VARCHAR(20)  ๐                        โ
โ โโ default_chatbot_id: UUID (FK โ chatbots)             โ
โ โโ is_fallback: BOOLEAN                                  โ
โ โโ webhook_url: VARCHAR                                  โ
โ โโ webhook_verify_token: VARCHAR                         โ
โ โโ created_at: TIMESTAMP                                 โ
โ โโ updated_at: TIMESTAMP                                 โ
โ                                                          โ
โ Indexes:                                                 โ
โ โโ UNIQUE(organization_id, phone_number)  ๐            โ
โ โโ INDEX(organization_id)  ๐                           โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ conversation_states (NEW - SEMANA 1)                     โ
โ โโ id: UUID (PK)                                         โ
โ โโ organization_id: UUID (FK โ organizations)  ๐        โ
โ โโ phone_number: VARCHAR(20)  ๐                        โ
โ โโ flow_id: UUID (FK โ flows)  ๐                       โ
โ โโ current_node_id: VARCHAR(255)                         โ
โ โโ variables: JSONB                                      โ
โ โโ execution_path: JSONB                                 โ
โ โโ is_active: BOOLEAN                                    โ
โ โโ last_message_at: TIMESTAMP                            โ
โ โโ session_expires_at: TIMESTAMP  โฐ TTL                 โ
โ โโ created_at: TIMESTAMP                                 โ
โ โโ updated_at: TIMESTAMP                                 โ
โ                                                          โ
โ Indexes:                                                 โ
โ โโ UNIQUE(organization_id, phone_number, flow_id)  ๐  โ
โ โโ INDEX(organization_id, is_active)  ๐               โ
โ โโ INDEX(session_expires_at)  โฐ For cleanup            โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                          โ
โ conversation_logs (NEW - SEMANA 1)                       โ
โ โโ id: UUID (PK)                                         โ
โ โโ organization_id: UUID (FK โ organizations)  ๐        โ
โ โโ phone_number: VARCHAR(20)  ๐                        โ
โ โโ flow_id: UUID (FK โ flows)  ๐                       โ
โ โโ user_message: TEXT                                    โ
โ โโ bot_response: TEXT                                    โ
โ โโ node_id: VARCHAR(255)                                 โ
โ โโ timestamp: TIMESTAMP  ๐                             โ
โ โโ metadata: JSONB                                       โ
โ                                                          โ
โ Indexes:                                                 โ
โ โโ INDEX(organization_id, flow_id, timestamp DESC)  ๐  โ
โ โโ INDEX(organization_id, phone_number, timestamp DESC) โ
โ                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ = Critical for multi-tenancy
โฐ = Performance optimization
```

---

## DIAGRAMA 5: Multi-tenancy Filtering

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ FRONTEND: User autenticado (JWT)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ JWT payload:                                          โ
โ {                                                     โ
โ   "sub": "user_123",                                  โ
โ   "org_id": "org_uuid_abc",  โ CHAVE!               โ
โ   "role": "org_admin",                                โ
โ   "iat": 1702392000                                   โ
โ }                                                     โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ FRONTEND: GET /api/v1/conversations                   โ
โ Headers: Authorization: Bearer <JWT>                  โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ BACKEND: Dependency Injection                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ @router.get("/conversations")                         โ
โ async def get_conversations(                           โ
โ   token = Depends(oauth2_scheme),                     โ
โ   db = Depends(get_db)                                โ
โ ):                                                    โ
โ   user = validate_token(token)  โ Extract JWT         โ
โ   org_id = user["org_id"]  โ Org ID do usuรกrio       โ
โ                                                       โ
โ   query = db.query(ConversationState).filter(         โ
โ     ConversationState.organization_id == org_id  โ ! โ
โ   )                                                   โ
โ                                                       โ
โ   return query.all()                                  โ
โ                                                       โ
โ โ GARANTIA: Nรฃo vaza dados de outra org             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## DIAGRAMA 6: Sequรชncia Temporal (Timeline)

```
T+0s:     User sends message on WhatsApp
          โ
T+0.1s:   Meta receives
          โ
T+0.2s:   Backend webhook receives POST
          โ
T+0.3s:   Backend validates signature
          โ
T+0.4s:   Backend enqueues background job
          โ
T+0.5s:   Backend returns 200 OK โ (webhook satisfied)
          
          [META CONSIDERS MESSAGE DELIVERED]
          
          โ
T+0.6s:   Background job starts (async)
T+1.2s:   Message router looks up chatbot
T+1.5s:   State manager loads/creates state
T+2.0s:   Flow executor processes all nodes
T+2.5s:   Message sender POSTs to Meta
T+2.7s:   Meta receives response
T+2.8s:   Background job completes โ
          
          โ
T+3.0s:   User receives message on WhatsApp
          (if everything is fast)

โฑ๏ธ Total async time: ~2-3 seconds
โฑ๏ธ Webhook response time: ~500ms
โฑ๏ธ User perception: Near-instant
```

---

## DIAGRAMA 7: Node Types & Execution

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ FLOW EXECUTION - Node Type Handlers             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                 โ
โ START                                           โ
โ โโ Input: (nothing)                             โ
โ โโ Action: Pass-through (no output)             โ
โ โโ Next: Follow first edge                      โ
โ โโ Example: [START] โ [MESSAGE]                โ
โ                                                 โ
โ MESSAGE                                         โ
โ โโ Input: (nothing)                             โ
โ โโ Action: Output text to user                  โ
โ โ          Substitute {{variables}}             โ
โ โโ Next: Follow edge                            โ
โ โโ Example: "Olรก {{nome}}!"                     โ
โ โ           If nome="Joรฃo" โ "Olรก Joรฃo!"        โ
โ โโ Response: ["Olรก Joรฃo!"]                      โ
โ                                                 โ
โ QUESTION                                        โ
โ โโ Input: user_message required                 โ
โ โโ Action: Store input in variables             โ
โ โ          Optionally validate (type check)     โ
โ โโ Next: Follow edge                            โ
โ โโ Example: variableName="product",             โ
โ โ           input="2" โ variables.product = "2" โ
โ โโ Awaiting: true (pause execution)             โ
โ                                                 โ
โ CONDITION                                       โ
โ โโ Input: (nothing, uses variables)             โ
โ โโ Action: Evaluate if condition                โ
โ โ          Compare: variables[X] [op] value     โ
โ โโ Next: trueNodeId OR falseNodeId              โ
โ โโ Example: if variables.product == "2"         โ
โ โ           โ go to "node_product_b_details"    โ
โ โโ Response: (no direct output)                 โ
โ                                                 โ
โ END                                             โ
โ โโ Input: (nothing)                             โ
โ โโ Action: Output final message                 โ
โ โโ Next: (none - finalize)                      โ
โ โโ Example: "Obrigado {{nome}}!"                โ
โ โโ Awaiting: false (conversation ends)          โ
โ                                                 โ
โ [FUTURE - Semana 5+]                            โ
โ โโ API_CALL: Call external API                  โ
โ โโ SET_VARIABLE: Manipulate variables           โ
โ โโ WEBHOOK: Trigger external event              โ
โ โโ WAIT: Delay execution                        โ
โ โโ SWITCH: Multi-branch decision                โ
โ                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Exemplo de execuรงรฃo:
[START] โ [MESSAGE "Olรก {{nome}}!"]
         โ [QUESTION "Nome?" (await)]
         โ [User: "Joรฃo"]
         โ [MESSAGE "Bem-vindo Joรฃo!"]
         โ [CONDITION: is_product_selected?]
         โโ YES โ [MESSAGE "Produtos..."]
         โ        โ [QUESTION "Qual?"] (await)
         โ        โ [User: "2"]
         โ        โ [END "Obrigado!"]
         โโ NO  โ [END "Tente novamente"]
```

---

**Autor:** Kayo Carvalho Fernandes  
**Versรฃo:** 1.0  
**รltima Atualizaรงรฃo:** 12 de dezembro de 2025
