# Sele√ß√£o de Agentes Permitidos por Fila - Implementa√ß√£o Completa ‚úÖ

## Task #9: Agent Restrictions per Queue

**Status**: ‚úÖ COMPLETO  
**Data**: 2024

---

## üìã Resumo

Implementado sistema de restri√ß√µes de agentes por fila, permitindo que administradores definam quais agentes podem atender conversas de filas espec√≠ficas. Conversas s√≥ podem ser atribu√≠das aos agentes permitidos.

---

## üéØ Objetivos Alcan√ßados

### Frontend
- ‚úÖ Componente `AgentMultiSelect` com multi-sele√ß√£o e busca
- ‚úÖ Integra√ß√£o no `QueueModal` (nova se√ß√£o "Agentes Permitidos")
- ‚úÖ API integrada para listar agentes ativos (GET /users?role=agent)
- ‚úÖ Salva sele√ß√£o em `queue.settings.allowed_agent_ids`

### Backend
- ‚úÖ Filtro de agentes no m√©todo `pull_from_queue()`
- ‚úÖ Valida√ß√£o de restri√ß√µes ao puxar conversa da fila
- ‚úÖ Suporte a `allowed_agent_ids` em `Queue.settings` (JSONB)

---

## üõ†Ô∏è Implementa√ß√£o

### Frontend

#### **1. AgentMultiSelect Component**

**Arquivo**: `/frontend/src/components/admin/AgentMultiSelect.tsx` (227 linhas)

**Features**:
- Multi-select com checkboxes
- Busca em tempo real (nome ou email)
- Selected badges com bot√£o de remo√ß√£o
- Dropdown com outside-click para fechar
- Loading states

**Interface**:
```typescript
export interface Agent {
  id: string;
  full_name: string;
  email: string;
  role: string;
  is_active: boolean;
}

interface AgentMultiSelectProps {
  selectedAgentIds: string[];
  onChange: (agentIds: string[]) => void;
  departmentId?: string; // Future: filter by department
}
```

**Integra√ß√£o API**:
```typescript
const response = await fetch('/api/v1/users?role=agent&is_active=true&limit=100', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`,
  },
});
```

**UI Elements**:
- **Selected Badges**: Mostra agentes selecionados com badge remov√≠vel (X)
- **Dropdown Trigger**: Bot√£o com contador `X agente(s) selecionado(s)`
- **Search Input**: Input com √≠cone Search (lucide)
- **Agent List**: Lista scroll√°vel com checkboxes e info (nome + email)

---

#### **2. QueueModal Integration**

**Arquivo**: `/frontend/src/components/admin/QueueModal.tsx`

**Mudan√ßas**:

1. **Importa√ß√£o**:
```typescript
import { Users } from 'lucide-react';
import AgentMultiSelect from './AgentMultiSelect';
```

2. **QueueFormData Interface** (atualizada):
```typescript
export interface QueueFormData {
  // ... campos existentes
  settings?: {
    allowed_agent_ids?: string[];
  };
}
```

3. **Estado Inicial** (updated):
```typescript
const [formData, setFormData] = useState<QueueFormData>({
  // ... campos existentes
  settings: {
    allowed_agent_ids: initialData?.settings?.allowed_agent_ids || [],
  },
});
```

4. **Nova Se√ß√£o** (ap√≥s "Configura√ß√µes de Overflow"):
```tsx
{/* Agent Restrictions Section */}
<div className="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6">
  <div className="flex items-center gap-2 mb-4">
    <Users className="w-5 h-5 text-blue-600" />
    <h3 className="text-base font-semibold text-gray-900 dark:text-white">
      Agentes Permitidos
    </h3>
  </div>
  <p className="text-sm text-gray-600 dark:text-gray-400 -mt-2 mb-4">
    Restrinja quais agentes podem atender conversas desta fila
  </p>

  <div>
    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
      Selecionar agentes
      <span className="text-gray-500 font-normal ml-1">(opcional)</span>
    </label>
    <AgentMultiSelect
      selectedAgentIds={formData.settings?.allowed_agent_ids || []}
      onChange={(agentIds) => {
        setFormData(prev => ({
          ...prev,
          settings: {
            ...prev.settings,
            allowed_agent_ids: agentIds,
          },
        }));
      }}
      departmentId={formData.department_id || undefined}
    />
    <p className="text-xs text-gray-500 mt-2">
      {formData.settings?.allowed_agent_ids?.length
        ? `${formData.settings.allowed_agent_ids.length} agente(s) selecionado(s)`
        : 'Todos os agentes podem atender (padr√£o)'}
    </p>
  </div>
</div>
```

**Visual**:
- √çcone: `Users` (lucide-react) azul
- T√≠tulo: "Agentes Permitidos"
- Descri√ß√£o: Explica√ß√£o clara do prop√≥sito
- Contador din√¢mico: Mostra quantos agentes selecionados

---

### Backend

#### **1. ConversationService.pull_from_queue()**

**Arquivo**: `/backend/app/services/conversation_service.py`

**Mudan√ßas** (linhas 206-258):

**Antes**:
```python
# Pegava primeira conversa com .limit(1)
result = await self.db.execute(query)
conversation = result.scalars().first()

if not conversation:
    return None

# Atribu√≠a diretamente
conversation.assign_to_agent(agent_id, department_id)
await self.db.commit()
return conversation
```

**Depois**:
```python
# Pega todas as conversas candidatas (sem .limit())
result = await self.db.execute(query)
conversations = result.scalars().all()

# Filtra por agentes permitidos
for conversation in conversations:
    if conversation.queue_id:
        # Get queue to check agent restrictions
        queue = await self.queue_repo.get(conversation.queue_id)
        if queue and queue.settings:
            allowed_agent_ids = queue.settings.get("allowed_agent_ids", [])
            
            # If allowed_agent_ids is set and not empty, check if agent is allowed
            if allowed_agent_ids and str(agent_id) not in allowed_agent_ids:
                continue  # Skip this conversation, agent not allowed
    
    # Found a conversation the agent can take
    conversation.assign_to_agent(agent_id, department_id)
    await self.db.commit()
    await self.db.refresh(conversation)
    return conversation

# No conversation found that agent can take
return None
```

**L√≥gica**:
1. Query retorna **todas** as conversas candidatas (ordenadas por prioridade/tempo)
2. Loop itera sobre cada conversa
3. Para cada conversa, verifica se h√° `queue.settings.allowed_agent_ids`
4. Se lista existir E n√£o vazia, verifica se `agent_id` est√° na lista
5. Se agente n√£o permitido, **skip** (continua para pr√≥xima conversa)
6. Se agente permitido (ou sem restri√ß√£o), **atribui** e retorna
7. Se nenhuma conversa compat√≠vel, retorna `None`

**Comportamento**:
- **Sem restri√ß√µes** (`allowed_agent_ids` vazio/null): Qualquer agente pode pegar
- **Com restri√ß√µes**: Apenas agentes na lista `allowed_agent_ids` podem pegar
- **Prioriza√ß√£o**: Mant√©m ordem (prioridade da fila > tempo de espera)

---

### Modelo de Dados

#### **Queue.settings JSONB**

**Estrutura**:
```json
{
  "allowed_agent_ids": ["uuid1", "uuid2", "uuid3"],
  "skills_required": ["python", "support"],
  "business_hours": {...}
}
```

**Tipo Backend** (Python):
- `Queue.settings`: `Column(JSONB, default={}, server_default=text("'{}'::jsonb"))`
- Validado como `Dict[str, Any]`

**Tipo Frontend** (TypeScript):
- `Queue.settings`: `Record<string, any>`
- `QueueFormData.settings.allowed_agent_ids`: `string[]`

---

## üìä Fluxo de Uso

### Admin Configurando Restri√ß√µes

1. **Acessar**: `/admin/queues` ‚Üí Clicar "Editar Fila"
2. **Rolar at√©**: Se√ß√£o "Agentes Permitidos" (ap√≥s Overflow)
3. **Selecionar Agentes**:
   - Clicar dropdown "Selecione agentes"
   - Buscar por nome ou email
   - Marcar checkboxes dos agentes permitidos
   - Ver badges com agentes selecionados
4. **Salvar**: Clicar "Salvar Altera√ß√µes"
5. **Resultado**: `queue.settings.allowed_agent_ids = ["uuid1", "uuid2"]`

### Agente Tentando Puxar Conversa

1. **Agente clica**: "Pegar da Fila" (endpoint `/queue/pull`)
2. **Backend busca**: Conversas em `status=queued` (ordenadas)
3. **Para cada conversa**:
   - Verifica se `conversation.queue_id` tem restri√ß√µes
   - Se `allowed_agent_ids` existe e n√£o vazia:
     - ‚úÖ Agente est√° na lista ‚Üí Atribui conversa
     - ‚ùå Agente N√ÉO est√° na lista ‚Üí Skip (pr√≥xima conversa)
   - Se `allowed_agent_ids` vazio/null ‚Üí Atribui (sem restri√ß√£o)
4. **Retorna**:
   - Conversa atribu√≠da (se encontrou compat√≠vel)
   - `null` (se nenhuma conversa compat√≠vel)

---

## üîç Casos de Uso

### Caso 1: Sem Restri√ß√µes (Padr√£o)
```json
{
  "queue_id": "q1",
  "name": "Suporte Geral",
  "settings": {
    "allowed_agent_ids": []
  }
}
```
**Comportamento**: Qualquer agente pode pegar conversas

---

### Caso 2: Com Restri√ß√µes
```json
{
  "queue_id": "q2",
  "name": "Suporte T√©cnico",
  "settings": {
    "allowed_agent_ids": ["agent-a", "agent-b"]
  }
}
```
**Comportamento**:
- Agent A ou Agent B ‚Üí ‚úÖ Pode pegar conversa
- Agent C ‚Üí ‚ùå N√£o pode pegar, retorna `null`

---

### Caso 3: M√∫ltiplas Conversas na Fila
```
Fila "Suporte T√©cnico":
  - Conv #1 (prioridade 10, 5 min esperando) ‚Üê allowed_agents: [A, B]
  - Conv #2 (prioridade 5, 10 min esperando) ‚Üê allowed_agents: [C]
```

**Agent A puxa**:
1. Verifica Conv #1 ‚Üí Agent A est√° em [A, B] ‚Üí ‚úÖ Atribui Conv #1

**Agent C puxa**:
1. Verifica Conv #1 ‚Üí Agent C N√ÉO est√° em [A, B] ‚Üí ‚ùå Skip
2. Verifica Conv #2 ‚Üí Agent C est√° em [C] ‚Üí ‚úÖ Atribui Conv #2

---

## üß™ Valida√ß√£o

### Frontend
```bash
# Verificar erros TypeScript
$ get_errors([
  "/frontend/src/components/admin/AgentMultiSelect.tsx",
  "/frontend/src/components/admin/QueueModal.tsx"
])
# Resultado: No errors found ‚úÖ
```

### Backend
```bash
$ podman exec pytake-backend python -c "
from app.services.conversation_service import ConversationService;
from app.models.queue import Queue;
print('‚úÖ Backend Agent Restrictions OK')
"
# Sa√≠da: ‚úÖ Backend Agent Restrictions OK
```

---

## üîÑ Compara√ß√£o com Estado Anterior

### Task #8 (Overflow) vs Task #9 (Agent Restrictions)

| Feature | Overflow (Task #8) | Agent Restrictions (Task #9) |
|---------|-------------------|------------------------------|
| **Problema** | Fila cheia | Agente n√£o qualificado |
| **A√ß√£o** | Redirecionar conversa | Skip conversa, buscar pr√≥xima |
| **Config** | `max_queue_size`, `overflow_queue_id` | `settings.allowed_agent_ids` |
| **L√≥gica** | Antes de adicionar √† fila | Ao puxar da fila |
| **Impacto** | Conversa muda de fila | Conversa fica aguardando outro agente |

---

## üé® Screenshots

### AgentMultiSelect Component
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Selected Badges]                       ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ ‚îÇ Jo√£o  X ‚îÇ ‚îÇ Maria X ‚îÇ ‚îÇ Pedro X ‚îÇ   ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ üë• 3 agente(s) selecionado(s)   ‚ñº ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (dropdown open)
‚îÇ ‚îÇ üîç Buscar agentes...              ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ ‚òë Jo√£o Silva                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ   joao@example.com                ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ ‚òê Ana Costa                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ   ana@example.com                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### QueueModal - Agent Section
```
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üë• Agentes Permitidos

Restrinja quais agentes podem atender
conversas desta fila

Selecionar agentes (opcional)
[AgentMultiSelect Component]

3 agente(s) selecionado(s)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

---

## üìù Pr√≥ximos Passos

### Melhorias Futuras (N√£o Essenciais)

1. **Filtro por Departamento**:
   - `AgentMultiSelect` j√° tem `departmentId` prop (n√£o implementado)
   - Endpoint: `/users?role=agent&department_id=X`
   - Requer relacionamento `User.department_id` (opcional)

2. **Skills System** (Tasks #10-11):
   - Evoluir `allowed_agent_ids` para `skills_required`
   - Matching autom√°tico por compet√™ncias
   - UI para gerenciar skills por agente

3. **Notifica√ß√µes**:
   - Alertar agente quando n√£o pode pegar conversa (por restri√ß√£o)
   - Toast: "Voc√™ n√£o tem permiss√£o para esta fila"

4. **M√©tricas**:
   - Adicionar ao dashboard: "Conversas rejeitadas por restri√ß√£o"
   - Gr√°fico: Distribui√ß√£o de conversas por agente permitido

---

## üìö Refer√™ncias

### Arquivos Modificados
- `/frontend/src/components/admin/AgentMultiSelect.tsx` (criado, 227 linhas)
- `/frontend/src/components/admin/QueueModal.tsx` (atualizado)
- `/frontend/src/types/queue.ts` (j√° tinha `settings: Record<string, any>`)
- `/backend/app/services/conversation_service.py` (m√©todo `pull_from_queue()`)

### Endpoints Utilizados
- `GET /api/v1/users?role=agent&is_active=true&limit=100` (listar agentes)
- `POST /api/v1/queues` (criar fila com `settings.allowed_agent_ids`)
- `PUT /api/v1/queues/{id}` (atualizar fila)
- `POST /api/v1/queue/pull` (puxar conversa, verifica restri√ß√µes)

### Dependencies
- **Frontend**: lucide-react (Icons: Users, Search, X)
- **Backend**: SQLAlchemy (JSONB support), asyncpg

---

## ‚úÖ Checklist de Conclus√£o

- [x] AgentMultiSelect component criado e funcional
- [x] Integra√ß√£o no QueueModal com se√ß√£o dedicada
- [x] API de listagem de agentes integrada
- [x] Estado `settings.allowed_agent_ids` salvo corretamente
- [x] Backend filtra conversas por agentes permitidos
- [x] M√©todo `pull_from_queue()` atualizado
- [x] Testes de compila√ß√£o (frontend + backend)
- [x] Documenta√ß√£o completa

---

**Task #9 - CONCLU√çDA** ‚úÖ  
**Progresso Geral**: 9/20 tarefas completas (45%)
