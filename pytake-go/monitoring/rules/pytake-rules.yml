# PyTake Backend - Prometheus Recording Rules
# Pre-computed metrics for better dashboard performance

groups:
- name: pytake-api-recording
  interval: 30s
  rules:
  # API Request Rate Rules
  - record: pytake:api_request_rate_5m
    expr: rate(http_requests_total{job="pytake-api"}[5m])
    labels:
      job: pytake-api

  - record: pytake:api_request_rate_1h
    expr: rate(http_requests_total{job="pytake-api"}[1h])
    labels:
      job: pytake-api

  # API Error Rate Rules
  - record: pytake:api_error_rate_5m
    expr: rate(http_requests_total{job="pytake-api",status=~"4..|5.."}[5m]) / rate(http_requests_total{job="pytake-api"}[5m])
    labels:
      job: pytake-api

  - record: pytake:api_error_rate_1h
    expr: rate(http_requests_total{job="pytake-api",status=~"4..|5.."}[1h]) / rate(http_requests_total{job="pytake-api"}[1h])
    labels:
      job: pytake-api

  # API Response Time Rules
  - record: pytake:api_response_time_p50_5m
    expr: histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{job="pytake-api"}[5m]))
    labels:
      job: pytake-api
      quantile: "0.5"

  - record: pytake:api_response_time_p95_5m
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="pytake-api"}[5m]))
    labels:
      job: pytake-api
      quantile: "0.95"

  - record: pytake:api_response_time_p99_5m
    expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="pytake-api"}[5m]))
    labels:
      job: pytake-api
      quantile: "0.99"

- name: pytake-whatsapp-recording
  interval: 30s
  rules:
  # WhatsApp Message Metrics
  - record: pytake:whatsapp_message_rate_5m
    expr: rate(whatsapp_messages_total[5m])

  - record: pytake:whatsapp_message_success_rate_5m
    expr: rate(whatsapp_messages_total{status="sent"}[5m]) / rate(whatsapp_messages_total[5m])

  - record: pytake:whatsapp_message_error_rate_5m
    expr: rate(whatsapp_messages_total{status="error"}[5m]) / rate(whatsapp_messages_total[5m])

  # WhatsApp Webhook Metrics
  - record: pytake:webhook_event_rate_5m
    expr: rate(webhook_events_total{source="whatsapp"}[5m])

  - record: pytake:webhook_processing_time_p95_5m
    expr: histogram_quantile(0.95, rate(webhook_processing_duration_seconds_bucket{source="whatsapp"}[5m]))

- name: pytake-database-recording
  interval: 60s
  rules:
  # Database Connection Metrics
  - record: pytake:db_connections_active
    expr: pg_stat_activity_count

  - record: pytake:db_connections_utilization
    expr: pg_stat_activity_count / pg_settings_max_connections

  # Database Performance Metrics
  - record: pytake:db_transaction_rate_5m
    expr: rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])

  - record: pytake:db_query_rate_5m
    expr: rate(pg_stat_database_tup_returned[5m])

  # Database Size Metrics
  - record: pytake:db_size_bytes
    expr: pg_database_size_bytes{datname="pytake"}

- name: pytake-redis-recording
  interval: 30s
  rules:
  # Redis Memory Metrics
  - record: pytake:redis_memory_utilization
    expr: redis_memory_used_bytes / redis_memory_max_bytes

  # Redis Command Metrics
  - record: pytake:redis_command_rate_5m
    expr: rate(redis_commands_processed_total[5m])

  - record: pytake:redis_keyspace_hits_rate_5m
    expr: rate(redis_keyspace_hits_total[5m])

  - record: pytake:redis_keyspace_misses_rate_5m
    expr: rate(redis_keyspace_misses_total[5m])

  - record: pytake:redis_hit_ratio_5m
    expr: rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))

- name: pytake-infrastructure-recording
  interval: 60s
  rules:
  # System CPU Metrics
  - record: pytake:system_cpu_usage_5m
    expr: 1 - rate(node_cpu_seconds_total{mode="idle"}[5m])

  # System Memory Metrics
  - record: pytake:system_memory_utilization
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes

  # System Disk Metrics
  - record: pytake:system_disk_utilization
    expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes

  # Network Metrics
  - record: pytake:system_network_receive_rate_5m
    expr: rate(node_network_receive_bytes_total[5m])

  - record: pytake:system_network_transmit_rate_5m
    expr: rate(node_network_transmit_bytes_total[5m])

- name: pytake-business-recording
  interval: 60s
  rules:
  # Active Users and Sessions
  - record: pytake:active_connections
    expr: active_connections

  - record: pytake:active_tenants
    expr: active_tenants

  # Campaign Metrics
  - record: pytake:campaign_active_count
    expr: campaigns_active_total

  - record: pytake:campaign_completion_rate_1h
    expr: rate(campaigns_completed_total[1h]) / rate(campaigns_started_total[1h])

  # Flow Execution Metrics
  - record: pytake:flow_execution_rate_5m
    expr: rate(flow_executions_total[5m])

  - record: pytake:flow_success_rate_5m
    expr: rate(flow_executions_total{status="completed"}[5m]) / rate(flow_executions_total[5m])

- name: pytake-security-recording
  interval: 60s
  rules:
  # Authentication Metrics
  - record: pytake:auth_success_rate_5m
    expr: rate(auth_attempts_total{result="success"}[5m]) / rate(auth_attempts_total[5m])

  - record: pytake:auth_failure_rate_5m
    expr: rate(auth_attempts_total{result="failure"}[5m])

  # Rate Limiting Metrics
  - record: pytake:rate_limit_hits_rate_5m
    expr: rate(rate_limit_hits_total[5m])

  # Security Event Metrics
  - record: pytake:unauthorized_access_rate_5m
    expr: rate(http_requests_total{status="401"}[5m])

  - record: pytake:forbidden_access_rate_5m
    expr: rate(http_requests_total{status="403"}[5m])

- name: pytake-sla-recording
  interval: 300s  # 5 minutes
  rules:
  # SLA Metrics (24 hour windows)
  - record: pytake:sla_availability_24h
    expr: avg_over_time(up{job="pytake-api"}[24h])

  - record: pytake:sla_error_rate_24h
    expr: avg_over_time(pytake:api_error_rate_5m[24h])

  - record: pytake:sla_response_time_p95_24h
    expr: avg_over_time(pytake:api_response_time_p95_5m[24h])

  # Weekly SLA Metrics
  - record: pytake:sla_availability_7d
    expr: avg_over_time(up{job="pytake-api"}[7d])

  - record: pytake:sla_error_rate_7d
    expr: avg_over_time(pytake:api_error_rate_5m[7d])

  # Monthly SLA Metrics
  - record: pytake:sla_availability_30d
    expr: avg_over_time(up{job="pytake-api"}[30d])

  - record: pytake:sla_error_rate_30d
    expr: avg_over_time(pytake:api_error_rate_5m[30d])

- name: pytake-cost-recording
  interval: 300s  # 5 minutes
  rules:
  # Cost and Usage Metrics
  - record: pytake:api_requests_per_tenant_5m
    expr: sum(rate(http_requests_total{job="pytake-api"}[5m])) by (tenant_id)

  - record: pytake:whatsapp_messages_per_tenant_5m
    expr: sum(rate(whatsapp_messages_total[5m])) by (tenant_id)

  - record: pytake:storage_usage_per_tenant
    expr: sum(tenant_storage_bytes) by (tenant_id)

  # Resource Utilization per Service
  - record: pytake:cpu_usage_per_service_5m
    expr: sum(rate(process_cpu_seconds_total[5m])) by (service)

  - record: pytake:memory_usage_per_service
    expr: sum(process_resident_memory_bytes) by (service)