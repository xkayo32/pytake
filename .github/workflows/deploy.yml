name: üöÄ Deploy (Manual Release - DESATIVADO - DEV APENAS)

# ‚ö†Ô∏è DESATIVADO: Este workflow foi desativado para modo desenvolvimento
# Em MODO DEV, utilizamos apenas docker-compose.yml local
# Reativar staging/production quando ambiente de produ√ß√£o estiver pronto

on:
  # ‚ö†Ô∏è COMENTADO: Desativado automaticamente para n√£o interferir no dev
  # workflow_dispatch:
  #   inputs:
  #     environment:
  #       description: 'Target environment'
  #       required: true
  #       type: choice
  #       options:
  #         - staging
  #         - production
  #     version:
  #       description: 'Release version (e.g., v1.0.0)'
  #       required: false
  #       type: string
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  pre-deploy-checks:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            TAG=${{ github.event.inputs.version }}
          else
            TAG=v$(date +%Y%m%d-%H%M%S)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "üìå Deploying version: $TAG"

      - name: Validate deployment files
        run: |
          echo "‚úì Checking docker-compose.yml..."
          [ -f docker-compose.yml ] || (echo "‚ùå docker-compose.yml not found" && exit 1)
          
          echo "‚úì Checking .env..."
          [ -f .env ] || (echo "‚ö†Ô∏è  .env not found (may be provided by CI/CD secrets)" && exit 0)
          
          echo "‚úì All deployment files present"

      - name: Create deployment tag
        run: |
          git tag -a ${{ steps.version.outputs.tag }} -m "Deploy to ${{ github.event.inputs.environment }}" || true
          echo "üìç Deployment tag created"

  deploy:
    needs: pre-deploy-checks
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: https://app.pytake.net

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.pre-deploy-checks.outputs.version }}

      - name: Set deployment environment
        run: |
          ENV="${{ github.event.inputs.environment || 'staging' }}"
          echo "DEPLOY_ENV=$ENV" >> $GITHUB_ENV
          echo "üéØ Target environment: $ENV"

      - name: Pre-deployment checks
        run: |
          echo "‚úì Running pre-deployment validation..."
          echo "  - Environment: ${{ env.DEPLOY_ENV }}"
          echo "  - Version: ${{ needs.pre-deploy-checks.outputs.version }}"
          echo "  - Branch: ${{ github.ref }}"
          echo "  - Commit: ${{ github.sha }}"

      - name: Deploy to production via SSH
        if: env.DEPLOY_ENV == 'production'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            echo "üì¶ Deploying PyTake to production..."
            cd /opt/pytake
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git checkout origin/main
            
            # Pull Docker images
            echo "üê≥ Pulling Docker images..."
            docker-compose pull
            
            # Start services
            echo "üöÄ Starting services..."
            docker-compose up -d --remove-orphans
            
            # Run migrations
            echo "üîÑ Running database migrations..."
            docker-compose exec -T backend alembic upgrade head || echo "‚ö†Ô∏è Migrations skipped"
            
            # Health check
            echo "üè• Checking health..."
            sleep 5
            docker-compose exec -T backend python -c "
            import urllib.request
            try:
              resp = urllib.request.urlopen('http://localhost:8000/api/v1/health', timeout=5)
              print(f'‚úÖ Backend health: {resp.status}')
            except Exception as e:
              print(f'‚ùå Health check failed: {e}')
              exit(1)
            "
            
            echo "‚úÖ Deployment completed successfully"

      - name: Deploy to staging (dry-run simulation)
        if: env.DEPLOY_ENV == 'staging'
        run: |
          echo "üìã STAGING DEPLOYMENT (DRY-RUN)"
          echo ""
          echo "Would execute on production server:"
          echo "  cd /opt/pytake"
          echo "  git fetch origin && git checkout origin/main"
          echo "  docker-compose pull"
          echo "  docker-compose up -d --remove-orphans"
          echo "  docker-compose exec -T backend alembic upgrade head"
          echo ""
          echo "‚ÑπÔ∏è To enable production deployment:"
          echo "  1. Add PROD_HOST, PROD_USER, PROD_SSH_KEY secrets"
          echo "  2. Setup production server (see PRODUCTION_DEPLOYMENT.md)"
          echo "  3. Select 'production' environment in workflow"

  post-deploy:
    needs: [pre-deploy-checks, deploy]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Health check
        run: |
          echo "üè• Running health checks..."
          echo "   API: https://api.pytake.net/api/v1/health"
          echo ""
          echo "‚è≥ Health checks would run here"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.pre-deploy-checks.outputs.version }}
          body: |
            ## Deployment Information
            
            - **Environment**: ${{ github.event.inputs.environment || 'staging' }}
            - **Version**: ${{ needs.pre-deploy-checks.outputs.version }}
            - **Branch**: ${{ github.ref }}
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}
            
            ### Deployed Images
            - Backend: `ghcr.io/${{ github.repository }}-backend:${{ needs.pre-deploy-checks.outputs.version }}`
          draft: false
          prerelease: false

      - name: Deployment success notification
        if: success()
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo ""
          echo "Release Information:"
          echo "  Version: ${{ needs.pre-deploy-checks.outputs.version }}"
          echo "  Environment: ${{ github.event.inputs.environment || 'staging' }}"
          echo "  Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
