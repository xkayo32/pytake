name: ğŸ”„ Auto-Merge on CI Pass

on:
  workflow_run:
    workflows: ["âœ… Testes - Erros CrÃ­ticos Apenas", "ğŸ—ï¸ Build & Test (Erros CrÃ­ticos Apenas)"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Find and Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const headCommit = context.payload.workflow_run.head_commit;
            console.log(`ğŸ” Procurando PR com commit: ${headCommit}`);

            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc',
              per_page: 50,
            });

            // Find PR associated with this workflow run
            let pr = null;
            for (const pullRequest of pullRequests) {
              if (pullRequest.head.sha === headCommit) {
                pr = pullRequest;
                break;
              }
            }

            if (!pr) {
              console.log('âŒ PR nÃ£o encontrada com esse commit');
              console.log(`Verificados ${pullRequests.length} PRs abertas`);
              return;
            }

            console.log(`âœ… PR encontrada: #${pr.number}`);

            // Check if PR is already merged or in draft
            if (pr.merged) {
              console.log(`â­ï¸  PR #${pr.number} jÃ¡ foi mergeada`);
              return;
            }

            if (pr.draft) {
              console.log(`â­ï¸  PR #${pr.number} estÃ¡ em draft`);
              return;
            }

            try {
              // Enable auto-merge with rebase strategy
              await github.rest.pulls.enableAutoMerge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'rebase',
              });

              console.log(`âœ… Auto-merge ativado para PR #${pr.number} com rebase`);
              
              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: 'âœ… CI/CD passou! Auto-merge ativado com rebase. A PR serÃ¡ mergeada automaticamente em breve.'
              });

              console.log(`ğŸ’¬ ComentÃ¡rio postado na PR #${pr.number}`);

            } catch (error) {
              console.log(`âš ï¸  Erro ao ativar auto-merge: ${error.message}`);
              // Don't fail the workflow - just log the error
            }
